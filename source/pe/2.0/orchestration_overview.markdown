---
layout: pe2experimental
title: "PE 2.0   Orchestration"
---

Orchestration for New PE Users
=====

## Puppet Enterprise Orchestration

This document introduces the command-line orchestration
capabilities of Puppet Enterprise 2.0. MCollective provides the
scriptable API on top of which the Live Management feature in
Puppet Enterprise Console is built.  Whereas Live Management offers
a convenient graphical interface to orchestration tasks, such as
browsing and cloning Puppet resources, the orchestration
command-line tools themselves can be used to fully automate these
tasks within a deployment.

### Changes in Orchestration Capability between PE 2.0 and 1.x

* The Live Management feature of Puppet Enterprise Console provides a web-based interface to underlying command-line orchestration tools.
* The mco local account has been renamed to peadmin in order to reflect the general use nature of this account.
* The puppetral plugin has been added as an interface to the Puppet Resource Abstraction Layer (RAL).
* The default message security scheme has changed from AES to PSK.
* The network connection over which messages are sent is now encrypted using SSL.

### Security Model

All network traffic generated by PE 2.0 s orchestration
capabilities is encrypted using SSL without host verification. In
addition, all orchestration messages are authenticated using a
Pre-Shared Key (PSK). Message security schemes other than PSK, such
as AES, can be configured, though there may be performance
considerations in doing so. The combination of PSK and SSL provides
both authentication and encryption.

#### How Can the Password be Changed?

The password used to authenticate orchestration messages is
randomly generated and stored in
`/etc/puppetlabs/mcollective/credentials` on the Puppet Enterprise
Master during installation. The password can be changed by editing
the contents of this file. For the password change to take effect,
the Puppet Agent on the Puppet Master must be run, followed by
running all other Puppet Agents. The password change can be
verified in the Puppet Enterprise Agent reports available in the
Puppet Enterprise Console.

#### What Ports Must be Opened in the Firewall?

Puppet Enterprise nodes send orchestration messages over TCP
connections to the orchestration server, which by default is on the
same machine as the Puppet Enterprise Master.  The default port for
orchestration messages is TCP 61613, though this can be configured
during the Puppet Enterprise installation process.

### Orchestration Actions Available in Puppet Enterprise 2.0

Orchestration actions are grouped and distributed as MCollective
plugins. In the default installation of Puppet Enterprise, the
mco command using the peadmin local account on the Puppet Master
can run any of the orchestration actions from any of the plugins,
an abbreviated selection of which includes:


* `rpcutil` plugin
  - `find` action returns a list of all nodes matching a search filter
  - `ping` action returns a list of all nodes and their latencies
  - `inventory` action returns a list of Facts, Classes, and other information from all nodes
  - this plugin's actions are exposed via higher-level wrappers, such as the mco ping command

* `puppetral` plugin
  - `find` action returns a Puppet resource of a given type and title and its variations across all nodes
  - `search` action returns all Puppet resources of a given type across all nodes
  - `create` action creates a given resource across all nodes
    - creating an exec resource allows for arbitrary management of nodes

* `puppetd` plugin
  - `enable` and `disable` actions start and stop puppetd on all Puppet Agents
  - `runonce` action initiates a Puppet run on all Puppet Agents in such a way as to spread out the load on the Puppet Master
  - `last_run_summary` action retrieves the most recent run summary from all Puppet Agents
  - `status` action returns the run status of all Puppet Agents

* `service` plugin
  - `start, stop, restart,` and `status` actions allow direct management of services across the deployment

* `package` plugin
  - `install, purge, checkupdate, update,` and `status` actions work through the system package manager to query and ensure the state of software packages across the deployment

* `controller` plugin
  - `stats` action returns cumulative statistics about MCollective messages passed between nodes
  - `reload_agent` action refreshes from disk the code for a specific plugin
  - `reload_agents` action refreshes from disk the code for all plugins
  - `exit` action removes nodes from the MCollective network

### Filtering Nodes

Most orchestration actions in Puppet Enterprise 2.0 can be executed
on a set of nodes determined by meta-data about the deployment.
This filtering provides a much more convenient way to manage nodes
than the traditional approach of using host names or fully
qualified domain names to identify and access machines.  Node sets
can be created by filtering based on Facter facts, Puppet classes,
and host names. Filters can be specified by passing options to the
mco command. For example:

    $ mco find --with-fact osfamily=RedHat

This command limits the find action to only return nodes who have a
fact named osfamily with a value of RedHat.  Filter options are
case sensitive and support regular expression syntax.

### Command-line Examples

#### Ping

The ping action of the rpcutil plugin is wrapped to be available at
a higher level as the mco ping command. This command returns a list
of all the nodes and their network latencies.  In a typical Puppet
Enterprise deployment, latencies for issuing an orchestration
action are less than half a second:

    peadmin@puppetmaster:~$ mco ping
    puppetmaster.example.com               time=135.94 ms
    agent.example.com                      time=136.55 ms
    ---- ping statistics ----
    2 replies max: 136.55 min: 135.94 avg: 136.25

#### Find

The find action of the rpcutil plugin is wrapped to be available at
a higher level as the mco find command. This command returns a list
of all the nodes in the network:

    peadmin@puppetmaster:~$ mco find
    puppetmaster.example.com
    agent.example.com

#### Inventory

The inventory action of the rpcutil plugin is wrapped to be
available at a higher level as the mco inventory command. This
command returns facts and classes, among other information:

    peadmin@puppetmaster:~$ mco inventory agent.example.com
    Inventory for agent.example.com:
     Server Statistics:
       Version: 1.2.1
       Start Time: Mon Nov 14 15:25:33 -0800 2011
       Config File: /etc/puppetlabs/mcollective/server.cfg
       Collectives: mcollective
       Main Collective: mcollective
       Process ID: 5553
       Total Messages: 86
       Messages Passed Filters: 74
       Messages Filtered: 12
       Replies Sent: 73
       Total Processor Time: 1.34 seconds
       System Time: 0.59 seconds
     Agents:
       discovery       package         puppetd        
       puppetral       rpcutil         service
     Configuration Management Classes:
       default                        helloworld
       helloworld                     pe_accounts
       pe_accounts                    pe_accounts::data
       pe_accounts::groups            pe_compliance
       pe_compliance                  pe_compliance::agent
       pe_mcollective                 pe_mcollective
       pe_mcollective::metadata       pe_mcollective::plugins
       settings
    Facts:
       architecture => i386
       augeasversion => 0.7.2
       ...

#### Puppetd

The puppetd plugin orchestrates Puppet itself across the
deployment. This plugin is capable of kicking off Puppet
configuration runs on each node in the deployment all at the same
time, on a subset of the deployment using filtering, or using a
maximum concurrency level. The maximum concurrency feature is
particularly noteworthy as it allows the execution of a
configuration run on all nodes in the population, but sets an upper
limit on the number of nodes that are performing their run at any
given time, thus mitigating the network load and resource demands
on the Puppet Master. This example performs a configuration run on
all nodes, but only one node at a time:

    peadmin@puppetmaster:~$ mco puppetd runall 1
    Tue Nov 15 11:17:11 -0800 2011> Running all machines with a concurrency of 1
    Tue Nov 15 11:17:11 -0800 2011> Discovering hosts to run
    Tue Nov 15 11:17:13 -0800 2011> Found 2 hosts
    Tue Nov 15 11:17:13 -0800 2011> Running agent.example.com, concurrency is 0
    Tue Nov 15 11:17:14 -0800 2011> agent.example.com schedule status: OK
    Tue Nov 15 11:17:15 -0800 2011> Currently 1 nodes running; waiting
    Tue Nov 15 11:17:21 -0800 2011> Running puppetmaster.example.com, concurrency is 0
    Tue Nov 15 11:17:22 -0800 2011> puppetmaster.example.com schedule status: OK
    Finished processing 1 / 1 hosts in 98.98 ms

Note, the "1 / 1 hosts" is an indication that one host was actually
performing the orchestration of the Puppet configuration run.  This
does not mean only one host in the deployment performed the
configuration run.  The message "Found 2 hosts" indicates that two
nodes carried out this action.

Once finished with the Puppet configuration run, the status action
can be used to see the last Puppet configuration run for each node
in the deployment.

    peadmin@puppetmaster:~$ mco puppetd status
    [ =============================================> ] 2 / 2
    agent.example.com  Enabled, not running, last run 10 seconds ago
    puppetmaster.example.com  Enabled, not running, last run 2 seconds ago

    Finished processing 2 / 2 hosts in 105.29 ms

#### PuppetRAL

The puppetral plugin provides a command line tool to work with any
resource Puppet is capable of managing.  A common use case for the
puppetral plugin is to execute arbitrary commands on the deployment
using the exec resource. This example creates a new file on all
nodes in the deployment:

    peadmin@puppetmaster:~$ mco rpc puppetral \
    create type=exec title="/bin/bash -c 'echo Hello > /tmp/hello'"
    Determining the amount of hosts matching filter for 2 seconds .... 2

    [ =================================================> ] 2 / 2

    agent.example.com                      
    Status: Resource was created
    Resource:
      {"exported"=>false, 
       "title"=>"/bin/bash -c 'echo Hello > /tmp/hello'",
       "parameters"=>{:returns=>:notrun},
       "tags"=>["exec"],
       "type"=>"Exec"}

     puppetmaster.example.com              
     Status: Resource was created
     Resource:
       {"exported"=>false,
        "title"=>"/bin/bash -c 'echo Hello > /tmp/hello'",
        "parameters"=>{:returns=>:notrun},
        "tags"=>["exec"],
        "type"=>"Exec"}

     Finished processing 2 / 2 hosts in 249.21 ms

That this file was created can be verified with the find action:

     peadmin@puppetmaster:~$ mco rpc puppetral find type=file title=/tmp/hello

     Determining the amount of hosts matching filter for 2 seconds .... 2

     [ ================================================> ] 2 / 2

     agent.example.com
       exported: false
       managed: false
       title: /tmp/hello
       parameters:
         {:ctime=>Tue Nov 15 11:32:10 -0800 2011,
          :type=>"file",
          :ensure=>:file,
          :group=>0,
          :owner=>0,
          :mtime=>Tue Nov 15 11:32:10 -0800 2011,
          :mode=>"644",
          :content=>"{md5}09f7e02f1290be211da707a266f153b3"}
      tags: ["file"]
      type: File

     puppetmaster.example.com
       managed: false
       exported: false
       title: /tmp/hello
       parameters:
         {:ctime=>Tue Nov 15 11:32:10 -0800 2011,
          :type=>"file",
          :group=>0,
          :ensure=>:file,
          :owner=>0,
          :mtime=>Tue Nov 15 11:32:10 -0800 2011,
          :mode=>"644",
          :content=>"{md5}09f7e02f1290be211da707a266f153b3"}
       tags: ["file"]
       type: File

     Finished processing 2 / 2 hosts in 166.12 ms

The puppetral plugin can manage any resource Puppet itself is
capable of managing. In particular, user, group, host, and
package resources are exposed directly in the Live Management
feature of Puppet Enterprise Console.

#### Service

While the Puppet Agent automatically restarts services when related
resources are changed, the mco service command can be used in cases
in which services need to be restarted outside of a normal Puppet
configuration run. This example restarts the SSH daemon on all
nodes running RedHat:

    peadmin@puppetmaster:~$ mco service sshd restart -W osfamily=RedHat
    [ ==================================================> ] 2/ 2
    ---- service summary ----
    Nodes: 2 / 2
    Statuses: started=2
    Elapsed Time: 1.45 s

The status of the restarted services can be found with:

    peadmin@puppetmaster:~$ mco service sshd status -W osfamily=RedHat
    [ ==================================================> ] 2 / 2
    puppetmaster.example.com               status=running
    agent.example.com                      status=running
    ---- service summary ----
    Nodes: 2 / 2
    Statuses: started=2
    Elapsed Time: 0.26 s

#### Package

Similar to the service plugin, the package manages software
packages outside of a normal Puppet configuration run. The
following is the trimmed output of running the
checkupdates action:

    peadmin@puppetmaster:~$ mco rpc package checkupdates
    Determining the amount of hosts matching filter for 2 seconds .... 2
    [ ===================================================> ] 2 / 2
    agent.example.com                      
       Outdated Packages:
              Output:
                kernel.i686                 2.6.18-274.7.1.el5          
                openssh.i386                4.3p2-72.el5_7.5            
                openssh-clients.i386        4.3p2-72.el5_7.5            
                openssh-server.i386         4.3p2-72.el5_7.5            
                openssl.i686                0.9.8e-20.el5                
                zlib.i386                   1.2.3-4.el5                  
       Exit Code: 100
       Package Manager: yum

     puppetmaster.example.com              
       Outdated Packages:
              Output:
                kernel.i686                           2.6.18-274.7.1.el5          
                ...
              Exit Code: 0
       Package Manager: yum

     Finished processing 2 / 2 hosts in 1703.97 ms

#### Controller

The mco controller command manages the underlying MCollective
infrastructure. This can be used to load plugins obtained outside
of Puppet Enterprise or custom written for the deployment. This
example reloads all plugins across the Puppet Enterprise
deployment:

     peadmin@puppetmaster:~$ mco controller reload_agents
     Determining the amount of hosts matching filter for 2 seconds .... 2
     agent.example.com> reloaded all agents
     puppetmaster.example.com> reloaded all agents
     Finished processing 2 / 2 hosts in 137.86 ms

### Conclusion

Puppet Enterprise 2.0 offers enhanced orchestration capability for
direct control of a deployment in real-time. These tools work both
in parallel and directly with Puppet and are available both from
the command-line and in the Live Management feature of Puppet
Enterprise Console.

